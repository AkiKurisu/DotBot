using DotBot.Abstractions;
using DotBot.Agents;
using Microsoft.Extensions.AI;

namespace DotBot.Tools;

/// <summary>
/// Provides core tools: file operations, shell execution, web tools, and agent spawning.
/// These tools are available in all running modes.
/// </summary>
public sealed class CoreToolProvider : IAgentToolProvider
{
    /// <inheritdoc />
    public int Priority => 10; // Core tools have highest priority (lowest number)

    /// <inheritdoc />
    public IEnumerable<AITool> CreateTools(ToolProviderContext context)
    {
        var tools = new List<AITool>();

        // Agent tools (subagent spawning)
        var subAgentManager = new SubAgentManager(
            context.ChatClient,
            context.WorkspacePath,
            context.Config.SubagentMaxToolCallRounds,
            maxConcurrency: context.Config.SubagentMaxConcurrency,
            shellTimeout: context.Config.Tools.Shell.Timeout,
            blacklist: context.PathBlacklist);
        var agentTools = new AgentTools(subAgentManager);
        tools.Add(AIFunctionFactory.Create(agentTools.SpawnSubagent));

        // File tools
        var userDotBotPath = Path.GetFullPath(Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), ".bot"));
        var fileTools = new FileTools(
            context.WorkspacePath,
            context.Config.Tools.File.RequireApprovalOutsideWorkspace,
            context.Config.Tools.File.MaxFileSize,
            context.ApprovalService,
            context.PathBlacklist,
            trustedReadPaths: [userDotBotPath]);
        tools.Add(AIFunctionFactory.Create(fileTools.ReadFile));
        tools.Add(AIFunctionFactory.Create(fileTools.WriteFile));
        tools.Add(AIFunctionFactory.Create(fileTools.EditFile));
        tools.Add(AIFunctionFactory.Create(fileTools.GrepFiles));
        tools.Add(AIFunctionFactory.Create(fileTools.FindFiles));

        // Shell tools
        var shellTools = new ShellTools(
            context.WorkspacePath,
            context.Config.Tools.Shell.Timeout,
            context.Config.Tools.Shell.RequireApprovalOutsideWorkspace,
            context.Config.Tools.Shell.MaxOutputLength,
            approvalService: context.ApprovalService,
            blacklist: context.PathBlacklist);
        tools.Add(AIFunctionFactory.Create(shellTools.Exec));

        // Web tools
        var webTools = new WebTools(
            context.Config.Tools.Web.MaxChars,
            context.Config.Tools.Web.Timeout,
            context.Config.Tools.Web.SearchMaxResults,
            context.Config.Tools.Web.SearchProvider);
        tools.Add(AIFunctionFactory.Create(webTools.WebSearch));
        tools.Add(AIFunctionFactory.Create(webTools.WebFetch));

        return tools;
    }
}
